name: Recreate Dev Branch

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  recreate-dev:
    # ä»…åœ¨ PR è¢«åˆå¹¶ä¸”æ¥æºåˆ†æ”¯æ˜¯ dev æ—¶è¿è¡Œ
    if: github.event.pull_request.merged == true && github.event.pull_request.head.ref == 'dev'
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Verify we are on main branch
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "âŒ é”™è¯¯ï¼šä¸åœ¨ main åˆ†æ”¯"
            exit 1
          fi
          echo "âœ… ç¡®è®¤åœ¨ main åˆ†æ”¯"
      
      - name: Pull latest main
        run: |
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°çš„ main åˆ†æ”¯..."
          git pull origin main
      
      - name: Check if dev branch exists
        id: check_dev
        run: |
          if git ls-remote --heads origin dev | grep -q dev; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ dev åˆ†æ”¯å­˜åœ¨ï¼Œå°†è¢«åˆ é™¤"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "ğŸ“Œ dev åˆ†æ”¯ä¸å­˜åœ¨ï¼Œå°†ç›´æ¥åˆ›å»º"
          fi
      
      - name: Delete old dev branch
        if: steps.check_dev.outputs.exists == 'true'
        run: |
          echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„ dev åˆ†æ”¯..."
          git push origin --delete dev
          echo "âœ… æ—§ dev åˆ†æ”¯å·²åˆ é™¤"
      
      - name: Wait for branch deletion
        if: steps.check_dev.outputs.exists == 'true'
        run: |
          echo "â³ ç­‰å¾… 2 ç§’ä»¥ç¡®ä¿åˆ†æ”¯å®Œå…¨åˆ é™¤..."
          sleep 2
      
      - name: Create new dev branch from main
        run: |
          echo "ğŸŒ± ä» main åˆ›å»ºæ–°çš„ dev åˆ†æ”¯..."
          git checkout -b dev
          git push origin dev
          echo "âœ… æ–° dev åˆ†æ”¯å·²åˆ›å»º"
      
      - name: Verify new dev branch
        run: |
          if git ls-remote --heads origin dev | grep -q dev; then
            echo "âœ… éªŒè¯æˆåŠŸï¼šæ–° dev åˆ†æ”¯å·²å­˜åœ¨äºè¿œç¨‹ä»“åº“"
            MAIN_COMMIT=$(git rev-parse main)
            DEV_COMMIT=$(git rev-parse origin/dev)
            echo "ğŸ“ main åˆ†æ”¯ commit: $MAIN_COMMIT"
            echo "ğŸ“ dev åˆ†æ”¯ commit: $DEV_COMMIT"
            if [ "$MAIN_COMMIT" = "$DEV_COMMIT" ]; then
              echo "âœ… dev åˆ†æ”¯ä¸ main åˆ†æ”¯åŒæ­¥"
            else
              echo "âš ï¸ è­¦å‘Šï¼šdev åˆ†æ”¯ä¸ main åˆ†æ”¯ä¸åŒæ­¥"
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ–° dev åˆ†æ”¯åˆ›å»ºå¤±è´¥"
            exit 1
          fi
      
      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… dev åˆ†æ”¯é‡å»ºå®Œæˆ"
          echo "ğŸ“ æ“ä½œæ‘˜è¦ï¼š"
          echo "   â€¢ PR #${{ github.event.pull_request.number }} å·²åˆå¹¶"
          echo "   â€¢ æ—§ dev åˆ†æ”¯å·²åˆ é™¤"
          echo "   â€¢ æ–° dev åˆ†æ”¯å·²ä» main åˆ›å»º"
          echo "   â€¢ æ–° dev åˆ†æ”¯ä¸ main ä¿æŒåŒæ­¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

