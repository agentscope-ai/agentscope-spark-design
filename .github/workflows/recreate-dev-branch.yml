name: Recreate Dev Branch

on:
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  recreate-dev:
    # ä»…åœ¨ PR è¢«åˆå¹¶ä¸”æ¥æºåˆ†æ”¯æ˜¯ dev-* æ ¼å¼ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰æ—¶è¿è¡Œ
    if: github.event.pull_request.merged == true && startsWith(github.event.pull_request.head.ref, 'dev-')
    runs-on: ubuntu-latest
    
    permissions:
      contents: write
      pull-requests: read
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Get old branch name and generate new branch name
        id: branch_name
        run: |
          # è·å–æ—§çš„ dev åˆ†æ”¯åï¼ˆæ¥æºåˆ†æ”¯ï¼‰
          OLD_BRANCH="${{ github.event.pull_request.head.ref }}"
          echo "old_branch=$OLD_BRANCH" >> $GITHUB_OUTPUT
          echo "ğŸ—‚ï¸ æ—§åˆ†æ”¯å: $OLD_BRANCH"
          
          # ç”Ÿæˆ yyyymmdd æ ¼å¼çš„æ—¶é—´æˆ³
          TIMESTAMP=$(date +%Y%m%d)
          NEW_BRANCH_NAME="dev-${TIMESTAMP}"
          echo "new_branch=$NEW_BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "ğŸ“… æ—¶é—´æˆ³: $TIMESTAMP"
          echo "ğŸŒ¿ æ–°åˆ†æ”¯å: $NEW_BRANCH_NAME"
      
      - name: Verify we are on main branch
        run: |
          CURRENT_BRANCH=$(git branch --show-current)
          echo "å½“å‰åˆ†æ”¯: $CURRENT_BRANCH"
          if [ "$CURRENT_BRANCH" != "main" ]; then
            echo "âŒ é”™è¯¯ï¼šä¸åœ¨ main åˆ†æ”¯"
            exit 1
          fi
          echo "âœ… ç¡®è®¤åœ¨ main åˆ†æ”¯"
      
      - name: Pull latest main
        run: |
          echo "ğŸ“¥ æ‹‰å–æœ€æ–°çš„ main åˆ†æ”¯..."
          git pull origin main
      
      - name: Delete old dev branch
        run: |
          OLD_BRANCH="${{ steps.branch_name.outputs.old_branch }}"
          echo "ğŸ—‘ï¸ åˆ é™¤æ—§çš„ $OLD_BRANCH åˆ†æ”¯..."
          if git ls-remote --heads origin "$OLD_BRANCH" | grep -q "$OLD_BRANCH"; then
            git push origin --delete "$OLD_BRANCH"
            echo "âœ… æ—§ $OLD_BRANCH åˆ†æ”¯å·²åˆ é™¤"
          else
            echo "ğŸ“Œ $OLD_BRANCH åˆ†æ”¯å·²ä¸å­˜åœ¨ï¼Œè·³è¿‡åˆ é™¤"
          fi
      
      - name: Wait for branch deletion
        run: |
          echo "â³ ç­‰å¾… 2 ç§’ä»¥ç¡®ä¿åˆ†æ”¯å®Œå…¨åˆ é™¤..."
          sleep 2
      
      - name: Create new dev branch from main
        run: |
          NEW_BRANCH="${{ steps.branch_name.outputs.new_branch }}"
          echo "ğŸŒ± ä» main åˆ›å»ºæ–°çš„ $NEW_BRANCH åˆ†æ”¯..."
          git checkout -b "$NEW_BRANCH"
          git push origin "$NEW_BRANCH"
          echo "âœ… æ–° $NEW_BRANCH åˆ†æ”¯å·²åˆ›å»º"
      
      - name: Verify new dev branch
        run: |
          NEW_BRANCH="${{ steps.branch_name.outputs.new_branch }}"
          if git ls-remote --heads origin "$NEW_BRANCH" | grep -q "$NEW_BRANCH"; then
            echo "âœ… éªŒè¯æˆåŠŸï¼šæ–° $NEW_BRANCH åˆ†æ”¯å·²å­˜åœ¨äºè¿œç¨‹ä»“åº“"
            MAIN_COMMIT=$(git rev-parse main)
            DEV_COMMIT=$(git rev-parse "origin/$NEW_BRANCH")
            echo "ğŸ“ main åˆ†æ”¯ commit: $MAIN_COMMIT"
            echo "ğŸ“ $NEW_BRANCH åˆ†æ”¯ commit: $DEV_COMMIT"
            if [ "$MAIN_COMMIT" = "$DEV_COMMIT" ]; then
              echo "âœ… $NEW_BRANCH åˆ†æ”¯ä¸ main åˆ†æ”¯åŒæ­¥"
            else
              echo "âš ï¸ è­¦å‘Šï¼š$NEW_BRANCH åˆ†æ”¯ä¸ main åˆ†æ”¯ä¸åŒæ­¥"
            fi
          else
            echo "âŒ é”™è¯¯ï¼šæ–° $NEW_BRANCH åˆ†æ”¯åˆ›å»ºå¤±è´¥"
            exit 1
          fi
      
      - name: Summary
        run: |
          OLD_BRANCH="${{ steps.branch_name.outputs.old_branch }}"
          NEW_BRANCH="${{ steps.branch_name.outputs.new_branch }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… dev åˆ†æ”¯é‡å»ºå®Œæˆ"
          echo "ğŸ“ æ“ä½œæ‘˜è¦ï¼š"
          echo "   â€¢ PR #${{ github.event.pull_request.number }} å·²åˆå¹¶"
          echo "   â€¢ æ—§ $OLD_BRANCH åˆ†æ”¯å·²åˆ é™¤"
          echo "   â€¢ æ–° $NEW_BRANCH åˆ†æ”¯å·²ä» main åˆ›å»º"
          echo "   â€¢ æ–° $NEW_BRANCH åˆ†æ”¯ä¸ main ä¿æŒåŒæ­¥"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

